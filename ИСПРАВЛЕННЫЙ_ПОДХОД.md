# üéØ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–î–•–û–î –ö –û–ë–†–ê–ë–û–¢–ö–ï –ü–û–î–ê–†–ö–û–í

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º

–¢—ã –±—ã–ª –ø—Ä–∞–≤! `MessageServiceType.GIFT` **–ù–ï –°–£–©–ï–°–¢–í–£–ï–¢** –≤ —Ç–µ–∫—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö pyrofork. –≠—Ç–æ –±—ã–ª–æ –º–æ–µ–π –æ—à–∏–±–∫–æ–π.

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ pyrofork, –≤–æ—Ç –∫–∞–∫ **–†–ï–ê–õ–¨–ù–û** –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏:

### 1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π**

```python
@client.on_message()
async def handle_message(client, message):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏
    if message.service:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º service —Å–æ–æ–±—â–µ–Ω–∏—è
        await check_service_gift(message)
    
    if message.media:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        await check_media_gift(message)
    
    if message.text:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        await check_text_gift(message)
```

### 2. **–î–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ–¥–∞—Ä–∫–æ–≤ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞**

```python
async def detect_gift_from_content(message):
    """–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ"""
    
    gift_indicators = [
        'gift', '–ø–æ–¥–∞—Ä–æ–∫', 'üéÅ', 'present',
        '–¥–∞—Ä—é', '–ø–æ–¥–∞—Ä–∏–ª', '–ø–æ–ª—É—á–∏–ª –ø–æ–¥–∞—Ä–æ–∫'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç
    if message.text:
        text_lower = message.text.lower()
        if any(indicator in text_lower for indicator in gift_indicators):
            return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–¥–∏–∞
    if message.media:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ–¥–∏–∞
        if hasattr(message.media, 'document'):
            if hasattr(message.media.document, 'mime_type'):
                # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤
                if 'gift' in str(message.media.document.mime_type).lower():
                    return True
    
    return False
```

### 3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ raw –¥–∞–Ω–Ω—ã—Ö**

```python
async def check_raw_data_for_gifts(message):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ raw –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤"""
    
    if hasattr(message, 'raw') and message.raw:
        raw_str = str(message.raw).lower()
        
        # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ raw –¥–∞–Ω–Ω—ã—Ö
        gift_patterns = [
            'gift', 'present', 'messageactiongift',
            'telegram_gift', 'premium_gift'
        ]
        
        for pattern in gift_patterns:
            if pattern in raw_str:
                return True
    
    return False
```

## üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ö–û–î

–í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

```python
@client.on_message()
async def universal_message_handler(client, message):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤"""
    
    try:
        # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ä–∫–∏
        is_gift = await advanced_gift_detection(message)
        
        if is_gift:
            logger.info(f"üéÅ –ü–û–î–ê–†–û–ö –û–ë–ù–ê–†–£–ñ–ï–ù! ID: {message.id}")
            
            # –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∞—Ä–∫–∞
            await process_gift_fast(message)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ: {e}")

async def advanced_gift_detection(message):
    """–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–æ–≤"""
    
    # –ú–µ—Ç–æ–¥ 1: Service —Å–æ–æ–±—â–µ–Ω–∏—è
    if message.service:
        service_str = str(message.service).lower()
        if any(word in service_str for word in ['gift', 'present']):
            return True
    
    # –ú–µ—Ç–æ–¥ 2: –ú–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
    if message.media:
        if await check_media_for_gift(message.media):
            return True
    
    # –ú–µ—Ç–æ–¥ 3: –¢–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
    if message.text:
        if await check_text_for_gift(message.text):
            return True
    
    # –ú–µ—Ç–æ–¥ 4: Raw –¥–∞–Ω–Ω—ã–µ
    if await check_raw_data_for_gifts(message):
        return True
    
    return False
```

## üéØ –ò–¢–û–ì

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
1. ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º `MessageServiceType.GIFT`
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
3. ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–µ—Ç–µ–∫—Ü–∏–∏
4. ‚úÖ –ê–Ω–∞–ª–∏–∑ service, media, text –∏ raw –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ asyncio

**–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!** –¢—ã —Å—ç–∫–æ–Ω–æ–º–∏–ª –≤—Ä–µ–º—è –Ω–∞ –æ—Ç–ª–∞–¥–∫–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–µ—Ç–æ–¥–∞.